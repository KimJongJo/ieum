<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mapper.main">
	
	<select id="selectMainHosList" resultType="mainHos">
		SELECT h.h_no, h.h_nm, h.h_address, h.hos_img_file_no, f.file_path AS hosImgPath, f.file_name AS hosImgNm, count(r.r_no) as resCount
		FROM hospital h 
		LEFT JOIN file f ON h.hos_img_file_no = f.file_no
		LEFT JOIN reservation r USING(h_no)  
		WHERE status = 'ACTIVE'
		GROUP BY h.h_no
		ORDER BY resCount DESC
		LIMIT 8
	</select>
	
	<select id="selectLoginInfo" resultType="mainUser">
		SELECT m.nickname, m.file_no AS profileNo , f.file_path AS profilePath, f.file_name AS profileNm
		FROM member m
		LEFT JOIN file f USING(file_no)
		WHERE m.u_no= #{value}
	</select>
	
	<select id="selectDiagnosis" resultType="mainDiag">
		SELECT e.exam_no, e.exam_category AS examCate, e.file_no AS examImgNo, f.file_path AS examImgPath, f.file_name AS examImgNm
		FROM exam e
		LEFT JOIN file f USING(file_no) 
		LIMIT 10
	</select>
	
	<select id="selectCommu" resultType="mainCommu">
		SELECT c.commu_no, c.commu_title, c.commu_content, cate.category_no, cate.category_name
		FROM community c
		JOIN commu_category cate 
		USING(category_no) ORDER BY commu_views DESC  LIMIT 3
	</select>
	
	<select id="selectNotice" parameterType="Integer" resultType="mainNotice">
		SELECT n_no, n_created, title, is_pinned
		FROM notice
		WHERE is_pinned = #{isPinned}
		ORDER BY n_created DESC
		LIMIT 3
	</select>
	
	<select id="selectMapList" parameterType="Map" resultType="mainHos">
	  <!--  두 지점(사용자 좌표와 DB에 저장된 좌표)의 거리(km) 를 구하는 Haversine 공식  -->
	  SELECT h_no, h_nm, h_location_y, h_location_x,
	  (
           6371 * ACOS(
               COS(RADIANS(#{userLocY}))      -- 사용자 위도
               * COS(RADIANS(h_location_y)) -- DB 위도
               * COS(RADIANS(h_location_x) - RADIANS(#{userLocX})) -- 경도 차
               + SIN(RADIANS(#{userLocY}))    -- 사용자 위도
               * SIN(RADIANS(h_location_y)) -- DB 위도
           )
       ) AS distance
		FROM hospital
		WHERE h_location_y IS NOT NULL
  		AND h_location_x IS NOT NULL
		ORDER BY distance ASC
		LIMIT 3	
	</select>
	
	<select id="selectMap" parameterType="Integer" resultType="mainHos">
		SELECT h_no, h_nm, h_tel, h_address, h_location_y, h_location_x,transfer_info, holiday_info
		FROM hospital WHERE h_no=#{hNo} 
	</select>

</mapper>	