<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mapper.diary">
	<insert id="insert" parameterType="diary">
		INSERT INTO diary
		(d_created,
		title, content, mood, u_no, target_dt)
		VALUES (now(), #{title},
		#{content}, #{mood}, #{uNo}, #{targetDt})
	</insert>
	<select id="selectDetail" parameterType="Integer"
		resultType="diary">
		SELECT * FROM diary WHERE d_no=#{dNo}
	</select>
	<select id="selectList" parameterType="map" resultType="diary">
		SELECT *
		FROM diary WHERE u_no=#{uNo} 
		<if test="keyword != null and keyword != ''">
		AND (title LIKE CONCAT('%', #{keyword}, '%')
        OR content LIKE CONCAT('%', #{keyword}, '%'))
        </if>
        <if test="sort != null and sort != ''">
		ORDER BY ${sort} DESC
		</if>
		LIMIT #{row}, 10
	</select>
	<select id="selectDiaryCnt" parameterType="map" resultType="Integer">
		SELECT COUNT(*) FROM diary
		WHERE u_no=#{uNo} 
		<if test="keyword != null and keyword != ''">
		AND (title LIKE CONCAT('%', #{keyword}, '%')
        OR content LIKE CONCAT('%', #{keyword}, '%'))
        </if>
	</select>
	<update id="update" parameterType="diary">
		UPDATE diary SET
		title=#{title}, content=#{content}, mood=#{mood}, d_updated=now()
		WHERE d_no=#{dNo}
	</update>
	<delete id="delete">
		DELETE FROM diary WHERE d_no=#{dNo}
	</delete>
	<select id="selectHisList" parameterType="Integer"
		resultType="diagnosisHistory">
		SELECT * FROM diagnosis_history WHERE patient_id = #{uNo}
	</select>
	<select id="selectDate" parameterType="map" resultType="diary">
		SELECT *
		FROM diary WHERE u_no=#{uNo} AND DATE(target_dt)=#{date}
	</select>
	<select id="selectCalList" parameterType="map"
		resultType="diary">
		SELECT *
		FROM diary
		WHERE u_no = #{uNo}
		AND target_dt &gt;= #{sDate}
		AND target_dt &lt;= #{eDate}
		ORDER BY target_dt ASC
	</select>
  
	<select id="selectPatientDiaryList" parameterType="Integer" resultType="diary">
		select d_no, u_no, d_updated, title, content, mood, target_dt, DATE_FORMAT(d_created, '%Y-%m-%d') as formatdCreated
		from diary
		where u_no = #{_parameter}
	</select>

	<!-- 1. 특정 u_no의 모든 diary 조회 -->
    <select id="selectAllByUser" parameterType="int" resultType="diary">
        SELECT d_no, u_no, title, content, target_dt
        FROM diary
        WHERE u_no = #{uNo}
        ORDER BY target_dt DESC
    </select>

</mapper>	