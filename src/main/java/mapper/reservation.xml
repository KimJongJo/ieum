<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mapper.reservation">

	<!-- 시간 조회 -->
	<select id="selectResTime" parameterType="map"
		resultType="reservation">
		select *
		from reservation
		where m_no=#{mNo} and
		r_date=#{rDate}
	</select>

	<!-- 예약하기 -->
	<insert id="insertReservation" parameterType="reservation"
		useGeneratedKeys="true" keyProperty="rNo">
		insert into reservation
		(r_date,r_time,r_content,act_name,act_tel,r_status,r_day,h_no,u_no,m_no)
		values
		(#{rDate},#{rTime},#{rContent},#{actName},#{actTel},#{rStatus},#{rDay},#{hNo},#{uNo},#{mNo})
	</insert>


	<!-- 오늘 예약인 예약 리스트 -->
	<select id="todayReservationList" parameterType="Map"
		resultType="diaInfo">
		select r.r_no, u.username as pNm, u.u_no as pNo,
		DATE_FORMAT(r.r_time, '%H:%i') AS time, d.diagnosis_state as diaState,
		d.diagnosis_no as diaNo
		FROM reservation r
		join member u using(u_no)
		join diagnosis_history d using(r_no)
		where DATE(r_date) = CURDATE()
		order by 4
		LIMIT #{pageSize} OFFSET #{offset}
	</select>

	<select id="resCount" parameterType="Integer"
		resultType="Integer">
		select count(*)
		FROM reservation r
		join member u using(u_no)
		join diagnosis_history d using(r_no)
		where DATE(r_date) = CURDATE()
		and
		r.m_no = #{_parameter}
		and d.is_completed = 0
	</select>



	<select id="resCountByManager" resultType="Integer">
		select count(*)
		FROM
		reservation r
		join member u using(u_no)
		join diagnosis_history d
		using(r_no)
		where DATE(r_date) = CURDATE()
		and d.is_completed = 0
	</select>



	<select id="todayReservationMyList" parameterType="Map"
		resultType="diaInfo">
		select r.r_no, u.username as pNm, u.u_no as pNo,
		DATE_FORMAT(r.r_time, '%H:%i') AS time, d.diagnosis_state as diaState,
		d.diagnosis_no as diaNo
		FROM reservation r
		join member u using(u_no)
		join diagnosis_history d using(r_no)
		where DATE(r_date) = CURDATE()
		and
		r.m_no = #{uNo}
		and d.is_completed = 0
		order by 4
		LIMIT #{pageSize}
		OFFSET #{offset}
	</select>


	<!-- 유저의 가장 최근 예약건 -->
	<select id="latestRes" parameterType="Integer"
		resultType="Integer">
		select MAX(r_no)
		from reservation
		where u_no =#{uNo}
	</select>

	<!-- 예약 상세 -->
	<select id="ResDetail" parameterType="Integer"
		resultType="resInfo">
		select *
		from reservation r
		left join hospital h
		using(h_no)
		left join member m
		on (r.m_no = m.u_no)
		where r_no=#{rNo}
	</select>

	<!-- 예약된 의사번호 -->
	<select id="resDocMno" parameterType="Integer"
		resultType="Integer">
		select m_no
		from reservation
		where r_no=#{rNo}
	</select>

	<!-- 다가오는예약 리스트 -->
	<select id="commingRes" parameterType="Integer"
		resultType="resInfo">
		select * ,
		<if test="_parameter != null">
			if(fav.hos_no is not null, 1, 0) as favorite
		</if>
		<if test="_parameter == null">
			0 as favorite
		</if>
		from reservation r
		join hospital h
		using(h_no)
		left join member m
		on
		(r.m_no = m.u_no)
		left join file f
		on (m.file_no = f.file_no)
		left join
		favorite fav
		on(fav.hos_no = h.h_no) and fav.u_no = #{uNo}
		where
		r.u_no=#{uNo} and r.r_status='WAITING'
		order by r.r_date ASC
	</select>

	<!-- 지난예약 리스트 수 -->
	<select id="recordResCnt" parameterType="map"
		resultType="Integer">
		select count(*)
		from reservation r
		left join hospital h
		using(h_no)
		left
		join member m
		on (r.m_no = m.u_no)
		left join file f
		on (m.file_no =
		f.file_no)
		where
		r.u_no=#{uNo} and r.r_status='COMPLETE'
		<if test="sort != null and sort != ''">
			and(
			r.r_date BETWEEN DATE_SUB(CURDATE(), INTERVAL #{sort}
			MONTH) AND CURDATE()
			)
		</if>
		<if test="keyword != null and keyword !=''">
			and(
			h.h_nm like concat('%', #{keyword}, '%')
			or m.username
			like concat('%', #{keyword}, '%')
			or r.r_date like concat('%',
			#{keyword}, '%')
			)
		</if>
	</select>

	<!-- 지난예약 리스트 -->
	<select id="recordRes" parameterType="map" resultType="resInfo">
		select *,
		<if test="uNo != null">
			if(fav.hos_no is not null, 1, 0) as favorite
		</if>
		<if test="uNo == null">
			0 as favorite
		</if>
		from reservation r
		left join hospital h
		using(h_no)
		left join member m
		on(r.m_no = m.u_no)
		left join file f
		on (m.file_no = f.file_no)
		left join
		favorite fav
		on(fav.hos_no = h.h_no) and fav.u_no = #{uNo}
		where
		r.u_no=#{uNo} and r.r_status='COMPLETE'
		<if test="sort != null and sort != ''">
			and(
			r.r_date BETWEEN DATE_SUB(CURDATE(), INTERVAL #{sort}
			MONTH) AND CURDATE()
			)
		</if>
		<if test="keyword != null and keyword !=''">
			and(
			h.h_nm like concat('%', #{keyword}, '%')
			or m.username
			like concat('%', #{keyword}, '%')
			or r.r_date like concat('%',
			#{keyword}, '%')
			)
		</if>
		order by r.r_date DESC
		limit #{offset}, #{pageSize}
	</select>

	<select id="selectDiaByRNo" parameterType="Integer"
		resultType="Map">
		SELECT u.u_no as pNo, u.birth_date as birthDate, u.u_tel as
		uTel,
		u.username as username, u.gender as gender, u.u_address as
		uAddress,
		d.diagnosis_no as diaNo, DATE(r.r_date) as rDate, h.h_nm as
		hNm, h.h_address as hAddress,
		m.username as mNm, m.major as major,
		d.diagnosis_name as diaName, d.sympotoms as sym, d.test_summary as
		summary, d.treatment as treatment,
		d.prescription as pre,
		d.doctor_comment as docComment
		from reservation r
		join member u
		ON(u.u_no = r.u_no)
		join member m on(r.m_no = m.u_no)
		join hospital h
		ON(r.h_no = h.h_no)
		join diagnosis_history d ON(r.r_no = d.r_no)
		where
		r.r_no = #{_parameter}
	</select>

	<select id="patientProfile" parameterType="Integer"
		resultType="Map">
		select m.u_no as pNo, m.birth_date as birthDate, m.u_tel as
		uTel, m.username as username,
		m.gender as gender, m.u_address as
		uAddress, r.r_content as content
		from reservation r
		join member m
		on(r.u_no = m.u_no)
		where r.r_no = #{_parameter}
	</select>

	<select id="resCountKeyword" parameterType="Map"
		resultType="Integer">
		select count(*)
		FROM reservation r
		join member u using(u_no)
		join diagnosis_history d using(r_no)
		where DATE(r_date) = CURDATE()
		and
		u.username like concat ('%', #{keyword}, '%')
		and r.m_no = #{uNo}
		and
		d.is_completed = 0
	</select>


	<!-- 병원관리자 - 키워드가 있는 오늘 예약 -->
	<select id="todayReservationListByKeyword" parameterType="Map"
		resultType="diaInfo">
		select r.r_no, u.username as pNm, u.u_no as pNo,
		DATE_FORMAT(r.r_time, '%H:%i') AS time, d.diagnosis_state as diaState,
		d.diagnosis_no as diaNo
		FROM reservation r
		join member u using(u_no)
		join diagnosis_history d using(r_no)
		where DATE(r_date) = CURDATE()
		and
		u.username like concat ('%', #{keyword}, '%')
		and d.is_completed = 0
		order by 4
		LIMIT #{pageSize} OFFSET #{offset}
	</select>

	<!-- 의사 - 키워드가 있는 오늘 예약 -->
	<select id="todayReservationMyListByKeyword" parameterType="Map"
		resultType="diaInfo">
		select r.r_no, u.username as pNm, u.u_no as pNo,
		DATE_FORMAT(r.r_time, '%H:%i') AS time, d.diagnosis_state as diaState,
		d.diagnosis_no as diaNo
		FROM reservation r
		join member u using(u_no)
		join diagnosis_history d using(r_no)
		where DATE(r_date) = CURDATE()
		and
		r.m_no = #{uNo}
		and u.username like concat ('%', #{keyword}, '%')
		and
		d.is_completed = 0
		order by 4
		LIMIT #{pageSize} OFFSET #{offset}
	</select>

	<!-- 예약취소(상태처리 변경) -->
	<update id="resCancel" parameterType="Integer">
		update reservation
		set
		r_status = 'CANCLED'
		where r_no = #{rNo}
	</update>


	<!-- 저에용 -->
	<select id="selectAllReservationList" parameterType="Integer"
		resultType="reservation">
		select r.r_date, d.diagnosis_state from reservation r
		JOIN diagnosis_history d ON r.r_no = d.r_no
		where u_no=#{uNo}
		AND d.diagnosis_state IS NOT NULL
		AND d.diagnosis_state != 'COMPLETED'
	</select>


	<!-- 예약 변경 -->
	<select id="selectRno" parameterType="Integer" resultType="reservation">
		select *
		from reservation
		where r_no = #{rNo}
	</select>

	<delete id="deleteRno" parameterType="Integer">
		delete from reservation
		where r_no =#{rNo}
	</delete>


</mapper>	