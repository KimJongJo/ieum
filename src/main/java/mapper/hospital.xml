<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mapper.hospital">
	
	<select id="select" parameterType="Integer" resultType="hospital">
	select  *
	from hospital  
	where h_no=#{hNo}
	</select>
	
	<select id="selectCount" resultType="Integer">
	select count(*) from hospital 
	</select>
	
	<!-- 병원페이지: 병원정보&의사정보 -->
	<select id="selectHosDetail" resultType="hosDetail">
	select h.h_no, h.h_nm, h.category_no, h.h_address, h.transfer_info, 
	h.holiday_info, h.h_tel, h.h_link, h.introduce_note, h.hos_img_file_no,
	h.hos_service, h.silson, m.username, m.major, m.introduction, m.file_no
	from hospital h
	join member m
	using (h_no)
	where h_no=#{hNo}
	</select>
	
	<!-- 필터 정렬: 예약 많은 순 -->
	<select id="selectListRes" parameterType="hosfilter" resultType="hosfilterlist">
	select h.h_nm,h.hos_img_file_no,h.transfer_info,hc.category_name, count(r.r_no) as resCount
	from hospital h
	left join reservation r 
	using (h_no)
	left join hos_category hc 
	using (category_no)
	<where>
	<if test="keyword !=null and keyword !=''">
	and h.h_nm like concat('%', #{keyword}, '%')
	</if>
	<if test="categoryName != null and categoryName.size >0">
	and hc.category_no in
	<foreach collection="categoryName" item="c" open="(" separator="," close=")">
	#{c}
	</foreach>
	</if>
	<if test="city != null and city !=''">
	and h.city = #{city}
	</if>
	<if test="gungu !=null and gungu !=''">
	and h.gungu = #{gungu}
	</if>
	</where>
	group by h.h_no, h.h_nm, h.hos_img_file_no, h.transfer_info
	order by resCount desc
	limit #{offset}, #{limit}
	</select>
	
	<insert id="addHospital" parameterType="hospital" useGeneratedKeys="true" keyProperty="hNo">
		insert into hospital (h_nm, h_address, h_location_y, h_location_x, holiday_info, h_tel, hosImgFile_no, hosReFile_no,
		hosReNo, h_created, status, city, gungu, category_no) 
		values (#{hNm}, #{hAddress}, #{hLocationY}, #{hLocationX}, #{holidayInfo}, #{hTel}, #{fileNo}, #{reNoFileNo},
		#{reNo}, NOW(), 'WAITING', #{city}, #{gungu}, #{categoryNo})
	</insert>
	
	<!-- 필터 정렬: 예약 많은 순 -->
	<select id="selectListResCnt" parameterType="hosfilter" resultType="Integer">
	select count(*)
	from hospital h
	left join reservation r 
	using (h_no)
	left join hos_category hc 
	using (category_no)
	<where>
	<if test="keyword !=null and keyword !=''">
	and h.h_nm like concat('%', #{keyword}, '%')
	</if>
	<if test="categoryName != null and categoryName.size >0">
	and hc.category_no in
	<foreach collection="categoryName" item="c" open="(" separator="," close=")">
	#{c}
	</foreach>
	</if>
	<if test="city != null and city !=''">
	and h.city = #{city}
	</if>
	<if test="gungu !=null and gungu !=''">
	and h.gungu = #{gungu}
	</if>
	</where>
	</select>	
</mapper>	