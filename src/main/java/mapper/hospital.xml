<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mapper.hospital">
	
	<select id="select" parameterType="Integer" resultType="hospital">
	select  *
	from hospital  
	where h_no=#{hNo}
	</select>
	
	<select id="selectCount" resultType="Integer">
	select count(*) from hospital 
	where status = 'ACTIVE'
	</select>
	
	<!-- 병원페이지: 병원정보 -->
	<select id="selectHosDetail" resultType="hosDetail">
	select h.h_no, h.h_nm, c.category_name, h.h_address, h.transfer_info, 
	h.holiday_info, h.h_tel, h.h_link, h.news_title,h.news_content, h.hos_img_file_no,
	h.services, h.silson
	from hospital h
	join hos_category c
	using (category_no)
	where h_no=#{hNo} and status = 'ACTIVE'
	</select>
	
	<!-- 병원: 의사정보 -->
	<select id="selectHosDetailDoc" resultType="hosDetail">
	select h.h_no,m.username, m.major, m.introduction, m.file_no
	from hospital h
	join member m
	using (h_no)
	where h_no=#{hNo} and status = 'ACTIVE'
	</select>
	
	<!-- 필터 정렬: 예약 많은 순 -->
	<select id="selectListRes" parameterType="hosfilter" resultType="hosfilterlist">
	select h.h_nm,h.h_no,h.hos_img_file_no,h.transfer_info,hc.category_name, count(r.r_no) as resCount
	from hospital h
	left join reservation r 
	using (h_no)
	left join hos_category hc 
	using (category_no)
	<where>
	<if test="keyword !=null and keyword !=''">
	and h.h_nm like concat('%', #{keyword}, '%')
	</if>
	<if test="categoryName != null and categoryName.size >0">
	and hc.category_no in
	<foreach collection="categoryName" item="c" open="(" separator="," close=")">
	#{c}
	</foreach>
	</if>
	<if test="city != null and city !=''">
	and h.city = #{city}
	</if>
	<if test="gungu !=null and gungu !=''">
	and h.gungu = #{gungu}
	</if>
	and status = 'ACTIVE'
	</where>
	group by h.h_no, h.h_nm, h.hos_img_file_no, h.transfer_info
	order by resCount desc
	limit #{offset}, #{limit}
	</select>
	
	<insert id="addHospital" parameterType="hospital" useGeneratedKeys="true" keyProperty="hNo">
		insert into hospital (h_nm, h_address, h_location_y, h_location_x, holiday_info, h_tel, hos_img_file_no, hos_re_file_no,
		hos_re_no, h_created, status, city, gungu, category_no, services, silson) 
		values (#{hNm}, #{hAddress}, #{hLocationY}, #{hLocationX}, #{holidayInfo}, #{hTel}, #{hosImgFileNo}, #{hosReFileNo},
		#{hosReNo}, NOW(), 'WAITING', #{city}, #{gungu}, #{categoryNo}, #{services}, #{silson})
	</insert>
	
	<!-- 필터 정렬: 갯수 -->
	<select id="selectListResCnt" parameterType="hosfilter" resultType="Integer">
	select count(*)
	from hospital h
	left join reservation r 
	using (h_no)
	left join hos_category hc 
	using (category_no)
	<where>
	<if test="keyword !=null and keyword !=''">
	and h.h_nm like concat('%', #{keyword}, '%')
	</if>
	<if test="categoryName != null and categoryName.size >0">
	and hc.category_no in
	<foreach collection="categoryName" item="c" open="(" separator="," close=")">
	#{c}
	</foreach>
	</if>
	<if test="city != null and city !=''">
	and h.city = #{city}
	</if>
	<if test="gungu !=null and gungu !=''">
	and h.gungu = #{gungu}
	</if>
	and status = 'ACTIVE'
	</where>
	</select>	
	
	<select id="hosWaitcount" resultType="Integer">
		select count(*) from hospital WHERE STATUS = 'WAITING';
	</select>
	
	<select id="selectWaithos" parameterType="Map" resultType="hospital">
		select * from hospital where status = 'WAITING'
		order by ${sortValue} ${sort}
    	LIMIT #{pageSize} OFFSET #{offset}
	</select>
	
	<update id="approve" parameterType="Integer">
		update hospital set status = 'ACTIVE' where h_no = #{hNo}
	</update>
	
	<update id="reject" parameterType="Integer">
		update hospital set status = 'REJECTED' where h_no = #{hNo}
	</update>
	
	<select id="hosWaitCountByKeyword" parameterType="String" resultType="Integer">
		select count(*) from hospital
		where status = 'WAITING'
		and (h_nm like concat ('%', #{keyword}, '%')
			or h_address like concat ('%', #{keyword}, '%')
			or h_tel like concat ('%', #{keyword}, '%'))
	</select>
	
	<select id="selectWaitHosByKeyword" parameterType="Map" resultType="hospital">
		select * from hospital
	    where status = 'WAITING'
	    and (h_nm like concat('%', #{keyword}, '%')
	         or h_address like concat('%', #{keyword}, '%')
	         or h_tel like concat('%', #{keyword}, '%'))
	    order by ${sortValue} ${sort}
	    limit #{pageSize} offset #{offset}
	</select>

	<update id="saveHosCode" parameterType="Map">
		update hospital set h_code = #{hCode} where h_no = #{hNo}
	</update>
	
	<select id="joinSearchHosName" parameterType="String" resultType="hospital">
		select * from hospital where h_nm like concat('%', #{keyword}, '%') and status = 'ACTIVE'
	</select>
	
	<select id="checkHosAuthCode" parameterType="Map" resultType="hospital">
		select * from hospital where h_no = #{hNo} and h_code = #{hosAuthCode}
	</select>

</mapper>	