<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mapper.diagnosis_history">
	
	<insert id="createDia" parameterType="diagnosisHistory">
		insert into diagnosis_history (patient_id, doctor_id, h_no, r_no, diagnosis_state, is_completed) 
		values (#{patientId}, #{doctorId}, #{hospitalId}, #{reservationNo}, 'BASIC', 0)
	</insert>
	
	<update id="tempSave" parameterType="diagnosisHistory">
		update diagnosis_history set diagnosis_name = #{diagnosisName}, sympotoms = #{sympotoms}, test_summary = #{testSummary},
		treatment = #{treatment}, prescription = #{prescription}, doctor_comment = #{doctorComment},
		diagnosis_state = 'WRITING'
		where diagnosis_no = #{diagnosisNo}
	</update>
	
	<update id="writeCompleted" parameterType="diagnosisHistory">
		update diagnosis_history set diagnosis_name = #{diagnosisName}, sympotoms = #{sympotoms}, test_summary = #{testSummary},
		treatment = #{treatment}, prescription = #{prescription}, doctor_comment = #{doctorComment},
		diagnosis_state = 'COMPLETED'
		where diagnosis_no = #{diagnosisNo}
	</update>
	
	<update id="diaCompleted" parameterType="Integer">
		update diagnosis_history set is_completed = 1 where diagnosis_no = #{_parameter}
	</update>
	
	<!-- 크기 비교 < 이걸 그대로 넣으면 xml 파일에러 발생 -->
	<select id="PastDiagnosesCount" parameterType="Integer" resultType="Integer">
      	SELECT COUNT(*)
		from diagnosis_history d
		join member u on(d.patient_id = u.u_no)
		join member m on(d.doctor_id = m.u_no)
		join reservation r on(d.r_no = r.r_no)
		WHERE d.doctor_id = #{_parameter}
		AND( DATE(r.r_date) &lt; CURDATE() or d.is_completed = 1)
	</select>
	
	<select id="diaDateCount" parameterType="Map" resultType="Integer">
      	SELECT COUNT(*)
		from diagnosis_history d
		join member u on(d.patient_id = u.u_no)
		join member m on(d.doctor_id = m.u_no)
		join reservation r on(d.r_no = r.r_no)
		WHERE d.doctor_id = #{uNo}
		AND( DATE(r.r_date) &lt; CURDATE() or d.is_completed = 1)
	    AND r.r_date >= #{date} 
	    AND r.r_date &lt; DATE_ADD(#{date}, INTERVAL 1 DAY)
	</select>
	
	<select id="diaKeywordCount" parameterType="Map" resultType="Integer">
	    SELECT count(*) 
	    FROM diagnosis_history d
	    JOIN reservation r ON (d.r_no = r.r_no)
	    join member u on (d.patient_id = u.u_no)
	    WHERE d.doctor_id = #{uNo}
      	AND (DATE(r.r_date) &lt; CURDATE() or d.is_completed = 1)
      	and u.username like concat ('%', #{keyword}, '%')
	</select>
	
	<select id="diaKeywordAndDateCount" parameterType="Map" resultType="Integer">
	    SELECT count(*) 
	    FROM diagnosis_history d
	    JOIN reservation r ON (d.r_no = r.r_no)
	    join member u on (d.patient_id = u.u_no)
	    WHERE d.doctor_id = #{uNo}
      	AND (DATE(r.r_date) &lt; CURDATE() or d.is_completed = 1)
      	and u.username like concat ('%', #{keyword}, '%')
	    AND r.r_date >= #{date} 
	    AND r.r_date &lt; DATE_ADD(#{date}, INTERVAL 1 DAY)
	</select>
	
	<select id="selectPastDiagnoses" parameterType="Map" resultType="diaInfo">
		SELECT d.r_no, u.username AS pNm, u.u_no AS pNo, DATE_FORMAT(r.r_time, '%H:%i') AS TIME, d.diagnosis_no AS diaNo,
		m.username AS mNm, DATE_FORMAT(r.r_date, '%Y-%m-%d') AS date
		from diagnosis_history d
		join member u on(d.patient_id = u.u_no)
		join member m on(d.doctor_id = m.u_no)
		join reservation r on(d.r_no = r.r_no)
		where d.doctor_id = #{uNo}
		AND( DATE(r.r_date) &lt; CURDATE() or d.is_completed = 1)
		order by 7 desc, 3 desc
		LIMIT #{pageSize} OFFSET #{offset}
	</select>
	
	<select id="pastDateDia" parameterType="Map" resultType="diaInfo">
		SELECT d.r_no, u.username AS pNm, u.u_no AS pNo, DATE_FORMAT(r.r_time, '%H:%i') AS TIME, d.diagnosis_no AS diaNo,
		m.username AS mNm, DATE_FORMAT(r.r_date, '%Y-%m-%d') AS date
		from diagnosis_history d
		join member u on(d.patient_id = u.u_no)
		join member m on(d.doctor_id = m.u_no)
		join reservation r on(d.r_no = r.r_no)
		where d.doctor_id = #{uNo}
		AND( DATE(r.r_date) &lt; CURDATE() or d.is_completed = 1)
	    AND r.r_date >= #{date} 
	    AND r.r_date &lt; DATE_ADD(#{date}, INTERVAL 1 DAY)
		order by 7 desc, 3 desc
		LIMIT #{pageSize} OFFSET #{offset}
	</select>
	
	<select id="pastKeywordDia" parameterType="Map" resultType="diaInfo">
		SELECT d.r_no, u.username AS pNm, u.u_no AS pNo, DATE_FORMAT(r.r_time, '%H:%i') AS TIME, d.diagnosis_no AS diaNo,
		m.username AS mNm, DATE_FORMAT(r.r_date, '%Y-%m-%d') AS date
		from diagnosis_history d
		join member u on(d.patient_id = u.u_no)
		join member m on(d.doctor_id = m.u_no)
		join reservation r on(d.r_no = r.r_no)
		where d.doctor_id = #{uNo}
		AND( DATE(r.r_date) &lt; CURDATE() or d.is_completed = 1)
		and u.username like concat ('%', #{keyword}, '%')
		LIMIT #{pageSize} OFFSET #{offset}
	</select>
	
	<select id="pastKeywordAndDateDia" parameterType="Map" resultType="diaInfo">
		SELECT d.r_no, u.username AS pNm, u.u_no AS pNo, DATE_FORMAT(r.r_time, '%H:%i') AS TIME, d.diagnosis_no AS diaNo,
		m.username AS mNm, DATE_FORMAT(r.r_date, '%Y-%m-%d') AS date
		from diagnosis_history d
		join member u on(d.patient_id = u.u_no)
		join member m on(d.doctor_id = m.u_no)
		join reservation r on(d.r_no = r.r_no)
		where d.doctor_id = #{uNo}
		AND( DATE(r.r_date) &lt; CURDATE() or d.is_completed = 1)
		and u.username like concat ('%', #{keyword}, '%')
	    AND r.r_date >= #{date} 
	    AND r.r_date &lt; DATE_ADD(#{date}, INTERVAL 1 DAY)
		LIMIT #{pageSize} OFFSET #{offset}
	</select>
	
	<select id="getDiaInfo" parameterType="Integer" resultType="Map">
		SELECT u.u_no AS pNo, u.birth_date AS birthDate, u.u_tel AS uTel,
		u.username AS pNm, u.gender AS gender, u.u_address AS uAddress,
		d.diagnosis_no AS diaNo, r.r_date AS rDate, h.h_nm AS hNm,
		m.username AS mNm, m.major AS major, h.h_address AS hAddress,
		d.diagnosis_name AS diaName, d.sympotoms AS sym,
		d.test_summary AS summary, d.treatment AS treatment,
		d.prescription AS pre, d.doctor_comment AS docComment
		from reservation r
		join member u ON(u.u_no = r.u_no)
		join member m on(r.m_no = m.u_no)
		join hospital h ON(r.h_no = h.h_no)
		join diagnosis_history d ON(r.r_no = d.r_no)
		where diagnosis_no = #{_parameter}
	</select>
	
	<select id="selectUserInfo" parameterType="Integer" resultType="Map">
		select m.u_no as uNo, m.birth_date as birthDate, m.u_tel as uTel, m.username as username,
		m.gender as gender, m.u_address as uAddress, m.diary_private as diaryPrivate, r.r_content AS rContent
		from diagnosis_history d
		join member m on(m.u_no = d.patient_id)
		join reservation r on(d.r_no = r.r_no)
		WHERE d.diagnosis_no = #{_parameter}
	</select>
	
	<select id="getDiaList" parameterType="Integer" resultType="diaInfo">
		SELECT d.diagnosis_no as diaNo, m.username as mNm,
		DATE_FORMAT(r.r_date, '%Y-%m-%d') as date, d.diagnosis_name as diaName
		FROM diagnosis_history d
		JOIN reservation r ON(d.r_no = r.r_no)
		JOIN member m ON(d.doctor_id = m.u_no)
		JOIN member u ON(d.patient_id = u.u_no)
		WHERE m.u_no = (SELECT doctor_id
							FROM diagnosis_history
							WHERE diagnosis_no = #{_parameter})
		AND u.u_no = (SELECT patient_id
							FROM diagnosis_history
							WHERE diagnosis_no = #{_parameter})
		AND d.diagnosis_state = 'COMPLETED'
		ORDER BY 1 DESC
	</select>
	
	<select id="getDiaAllList" parameterType="Integer" resultType="diaInfo">
		SELECT d.diagnosis_no as diaNo, m.username as mNm,
		DATE_FORMAT(r.r_date, '%Y-%m-%d') as date, d.diagnosis_name as diaName
		FROM diagnosis_history d
		JOIN reservation r ON(d.r_no = r.r_no)
		JOIN member m ON(d.doctor_id = m.u_no)
		JOIN member u ON(d.patient_id = u.u_no)
		where u.u_no = (SELECT patient_id
							FROM diagnosis_history
							WHERE diagnosis_no = #{_parameter})
		AND d.diagnosis_state = 'COMPLETED'
		ORDER BY 1 DESC
	</select>
	
	<select id="getUserDiaDetail" parameterType="Integer" resultType="shwoDiaInfo">
		SELECT u.username AS uNm, u.gender, u.birth_date, d.diagnosis_name,
		d.sympotoms, d.test_summary, d.treatment, d.doctor_comment, d.prescription,
		m.username AS mNm, DATE_FORMAT(r.r_date, '%Y-%m-%d') as rDate, m.major, h.h_nm, f.file_name AS docFileName, f.file_path AS docFilePath
		FROM diagnosis_history d
		JOIN member u ON(d.patient_id = u.u_no)
		JOIN member m ON(d.doctor_id = m.u_no)
		JOIN reservation r ON(d.r_no = r.r_no)
		JOIN file f ON(f.file_no = m.file_no)
		JOIN hospital h ON(m.h_no = h.h_no)
		WHERE d.diagnosis_no = #{_parameter}
		AND d.diagnosis_state = 'COMPLETED'
		order by r.r_date desc
	</select>
	
	<select id="getUserDiaList" parameterType="Map" resultType="shwoDiaInfo">
		SELECT d.diagnosis_name, d.test_summary, d.doctor_comment, d.diagnosis_no as diaNo,
		DATE_FORMAT(r.r_date, '%Y-%m-%d') as rDate, h.h_nm
		FROM diagnosis_history d
		JOIN member u ON(d.patient_id = u.u_no)
		JOIN member m ON(d.doctor_id = m.u_no)
		JOIN reservation r ON(d.r_no = r.r_no)
		JOIN file f ON(f.file_no = m.file_no)
		JOIN hospital h ON(m.h_no = h.h_no)
		WHERE u.u_no = #{uNo}
		AND d.diagnosis_state = 'COMPLETED'
		order by r.r_date desc
		LIMIT #{limit} OFFSET #{offset}
	</select>
	
	<select id="getUserDiaListByDate" parameterType="Map" resultType="shwoDiaInfo">
	    SELECT d.diagnosis_name AS diagnosisName,
	           d.test_summary AS testSummary,
	           d.doctor_comment AS doctorComment,
	           d.diagnosis_no AS diaNo,
	           DATE_FORMAT(r.r_date, '%Y-%m-%d') AS rDate,
	           h.h_nm AS hNm
	    FROM diagnosis_history d
	    JOIN member u ON d.patient_id = u.u_no
	    JOIN member m ON d.doctor_id = m.u_no
	    JOIN reservation r ON d.r_no = r.r_no
	    JOIN hospital h ON m.h_no = h.h_no
	    WHERE u.u_no = #{uNo}
	      AND DATE(r.r_date) = #{date}
	      AND d.diagnosis_state = 'COMPLETED'
	    ORDER BY r.r_date DESC
	    LIMIT #{offset}, #{limit}
	</select>
	
	<select id="getTotalCount" parameterType="Integer" resultType="Integer">
		SELECT count(*)
		FROM diagnosis_history d
		JOIN member u ON(d.patient_id = u.u_no)
		JOIN member m ON(d.doctor_id = m.u_no)
		JOIN reservation r ON(d.r_no = r.r_no)
		JOIN file f ON(f.file_no = m.file_no)
		JOIN hospital h ON(m.h_no = h.h_no)
		WHERE u.u_no = #{uNo}
		AND d.diagnosis_state = 'COMPLETED'
	</select>
	
	<select id="getTotalCountByDate" parameterType="Map" resultType="Integer">
	    SELECT COUNT(*)
	    FROM diagnosis_history d
	    JOIN member u ON d.patient_id = u.u_no
	    JOIN reservation r ON d.r_no = r.r_no
	    WHERE u.u_no = #{uNo}
      	AND DATE(r.r_date) = #{date}
      	AND d.diagnosis_state = 'COMPLETED'
	</select>
	
	<select id="selectAllDiaList" parameterType="Integer" resultType="Map">
		SELECT d.diagnosis_no AS id, DATE_FORMAT(r.r_date, '%Y-%m-%d') AS start,
		h.h_nm AS title, TRUE AS allDay
		FROM diagnosis_history d
		JOIN reservation r ON(d.r_no = r.r_no)
		JOIN hospital h ON(d.h_no = h.h_no)
		JOIN member u ON(d.patient_id = u.u_no)
		WHERE u.u_no = #{_parameter}
		AND d.diagnosis_state = 'COMPLETED'
	</select>
	
	<select id="selectDiaByNo" parameterType="Integer" resultType="shwoDiaInfo">
		SELECT d.diagnosis_name, d.test_summary, d.doctor_comment, d.diagnosis_no as diaNo,
		DATE_FORMAT(r.r_date, '%Y-%m-%d') as rDate, h.h_nm
		FROM diagnosis_history d
		JOIN member u ON(d.patient_id = u.u_no)
		JOIN member m ON(d.doctor_id = m.u_no)
		JOIN reservation r ON(d.r_no = r.r_no)
		JOIN file f ON(f.file_no = m.file_no)
		JOIN hospital h ON(m.h_no = h.h_no)
		WHERE d.diagnosis_no = #{diaNo}
		AND d.diagnosis_state = 'COMPLETED'
	</select>
	
</mapper>	